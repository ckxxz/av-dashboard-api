<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>AVë¶€ ì‚¬ì „ì„¤ì¹˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (íŒ€ì¥ìš©)</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ê³ ì–‘04 AVê³µì •í‘œ" />
    <link rel="apple-touch-icon" href="/icons/icon-180x180-woker.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f8fafc;
      }
      .filter-btn.active {
        background-color: #3b82f6;
        color: white;
      }
      .filter-btn:not(.active) {
        background-color: white;
        color: #374151;
        border: 1px solid #d1d5db;
      }
      #loading-overlay {
        transition: opacity 0.3s ease;
      }
      .task-row.completed {
        background-color: #dcfce7;
      }
      .task-row.completed .task-name {
        text-decoration: line-through;
        color: #64748b;
      }
      .task-row {
        transition: background-color 0.2s ease-in-out;
      }
      .task-row:hover {
        background-color: #eff6ff;
      }

      /* --- MOBILE OPTIMIZATION START --- */
      @media (max-width: 768px) {
        header.flex {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .tab-btn {
          flex: 1;
          text-align: center;
          font-size: 0.875rem;
          padding: 0.5rem 0.25rem;
        }

        nav.flex {
          flex-wrap: wrap;
          justify-content: space-between;
          gap: 0.5rem;
        }

        .chart-container {
          height: 180px !important;
          width: 100% !important;
        }

        .grid-cols-2,
        .grid-cols-4,
        .md\:grid-cols-2,
        .lg\:grid-cols-4,
        .md\:grid-cols-3,
        .lg\:grid-cols-2 {
          grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
        }

        .sm\:grid-cols-4 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .text-3xl {
          font-size: 1.5rem !important;
        }
        .text-2xl {
          font-size: 1.25rem !important;
        }
        .text-xl {
          font-size: 1.125rem !important;
        }
        .text-lg {
          font-size: 1rem !important;
        }
        .text-sm {
          font-size: 0.875rem !important;
        }

        .p-6 {
          padding: 1rem !important;
        }
        .p-4 {
          padding: 0.75rem !important;
        }

        .overflow-x-auto table {
          min-width: 720px;
        }

        /* ì‚¬ì „ì„¤ì¹˜ ê³µì •í‘œ ë‚´ íŒ€, ë‹´ë‹¹ì ë„ˆë¹„ ì¦ê°€ */
        #worker-tasks-table td:nth-child(3),
        #worker-tasks-table td:nth-child(6) {
          min-width: 80px;
          white-space: nowrap;
        }
      }
      /* â€” MOBILE OPTIMIZATION END â€” */
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50"
    >
      <div class="text-center">
        <svg
          class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-lg font-semibold text-slate-700">
          ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </p>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-6">
      <header class="mb-6 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-slate-900">
            AVë¶€ ì‚¬ì „ì„¤ì¹˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (íŒ€ì¥ìš©)
          </h1>
          <p class="text-slate-600 mt-1">
            ë‹´ë‹¹ ì‘ì—…ì„ í™•ì¸í•˜ê³ , ì§„í–‰ ìƒíƒœì™€ ë©”ëª¨ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.
          </p>
        </div>
        <button
          id="refresh-button"
          class="p-2 rounded-full hover:bg-slate-200 active:bg-slate-300 transition-colors"
          aria-label="ìƒˆë¡œê³ ì¹¨"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-slate-600"
          >
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
            <path d="M21 3v5h-5" />
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
            <path d="M3 21v-5h5" />
          </svg>
        </button>
      </header>

      <main>
        <!-- ë‚ ì§œ í•„í„° -->
        <div id="date-filter-controls" class="mb-2">
          <span class="text-sm text-slate-700 whitespace-nowrap"
            >ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</span
          >
          <select
            id="date-filter"
            class="px-3 py-1 text-sm rounded-md border border-gray-300"
          >
            <option value="All">ì „ì²´ ë‚ ì§œ</option>
            <option value="2025-08-13">2025ë…„ 8ì›” 13ì¼</option>
            <option value="2025-08-14">2025ë…„ 8ì›” 14ì¼</option>
            <option value="2025-08-15">2025ë…„ 8ì›” 15ì¼</option>
            <option value="2025-08-16">2025ë…„ 8ì›” 16ì¼</option>
            <option value="2025-08-17">2025ë…„ 8ì›” 17ì¼</option>
          </select>
        </div>

        <!-- íŒ€ í•„í„° -->
        <div id="team-filter-controls" class="mb-4 overflow-x-auto">
          <div class="flex space-x-2 w-max min-w-full flex-nowrap">
            <button
              data-team="All"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md active min-w-fit"
            >
              ì „ì²´
            </button>
            <button
              data-team="ì˜¤ë””ì˜¤íŠ¸ëŸ¬ìŠ¤íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ì˜¤ë””ì˜¤íŠ¸ëŸ¬ìŠ¤íŒ€
            </button>
            <button
              data-team="ì‚¬ì´ë“œìŠ¤í”¼ì»¤íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ì‚¬ì´ë“œìŠ¤í”¼ì»¤íŒ€
            </button>
            <button
              data-team="ì˜¤ë””ì˜¤AVë°ìŠ¤í¬íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ì˜¤ë””ì˜¤AVë°ìŠ¤í¬íŒ€
            </button>
            <button
              data-team="ì „ê¸°íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ì „ê¸°íŒ€
            </button>
            <button
              data-team="ì „ê´‘íŒíŠ¸ëŸ¬ìŠ¤íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ì „ê´‘íŒíŠ¸ëŸ¬ìŠ¤íŒ€
            </button>
            <button
              data-team="ë¹„ë””ì˜¤ì¼€ì´ë¸”íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ë¹„ë””ì˜¤ì¼€ì´ë¸”íŒ€
            </button>
            <button
              data-team="ë¹„ë””ì˜¤AVë°ìŠ¤í¬íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ë¹„ë””ì˜¤AVë°ìŠ¤í¬íŒ€
            </button>
            <button
              data-team="ë¬´ëŒ€íŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ë¬´ëŒ€íŒ€
            </button>
            <button
              data-team="ITíŒ€"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md min-w-fit"
            >
              ITíŒ€
            </button>
          </div>
        </div>

        <!-- í…Œì´ë¸” -->
        <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="p-3">íŒ€</th>
                <th class="p-3 text-center">ìƒíƒœ</th>
                <th class="p-3">ì‘ì—… í•­ëª©</th>
                <th class="p-3 text-center min-w-[64px]">ë©”ëª¨</th>
                <th class="p-3">ë‹´ë‹¹ì</th>
                <th class="p-3">ì‹œì‘ ì˜ˆì •</th>
                <th class="p-3">ì™„ë£Œ ëª©í‘œ</th>
                <th class="p-3 min-w-[64px]">ìë£Œ</th>
              </tr>
            </thead>
            <tbody id="worker-tasks-table">
              <!-- rows -->
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <!-- ë©”ëª¨ íŒì—… -->
    <div
      id="memo-popup"
      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded shadow-lg w-[90%] max-w-md">
        <h2 class="text-lg font-semibold mb-2">ë©”ëª¨</h2>
        <textarea
          id="memo-textarea"
          class="w-full h-32 p-2 border rounded"
        ></textarea>
        <div class="flex justify-end mt-4 space-x-2">
          <button
            onclick="closeMemoPopup()"
            class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
          >
            ë‹«ê¸°
          </button>
          <button
            onclick="saveMemo()"
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- ê³µí†µ ìƒìˆ˜ (facì™€ ë™ì¼) ---
      const statusOrder = ["ëŒ€ê¸°", "ì§„í–‰ì¤‘", "ì™„ë£Œ", "ë¬¸ì œ", "ë³´ë¥˜"];
      const statusColorMap = {
        ëŒ€ê¸°: "bg-gray-400",
        ì§„í–‰ì¤‘: "bg-blue-500",
        ì™„ë£Œ: "bg-green-500",
        ë¬¸ì œ: "bg-red-500",
        ë³´ë¥˜: "bg-yellow-500",
      };

      let tasks = [];
      let currentFilter = "All";
      let currentDateFilter = "All";

      // --- ë°ì´í„° ë¡œë“œ ---
      async function fetchData() {
        const res = await fetch("/api/avSetupTasks");
        if (!res.ok) throw new Error("Failed to fetch avSetupTasks");
        const data = await res.json();
        // completed í•„ë“œ ë¬¸ìì—´ ê¸°ë°˜ ì •ê·œí™” (facì™€ ë™ì¼ ìŠ¤í‚¤ë§ˆ ê°€ì •)
        tasks = data.map((d) => ({
          ...d,
          id: parseInt(d.id),
          completed: (d.completed || "ëŒ€ê¸°").trim(), // "ëŒ€ê¸°"/"ì§„í–‰ì¤‘"/"ì™„ë£Œ"/...
        }));
      }

      // --- ìƒíƒœ í† ê¸€ (facì™€ ë™ì¼ UX) ---
      async function updateTaskStatus(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;
        const currentIndex = statusOrder.indexOf(task.completed);
        const nextStatus = statusOrder[(currentIndex + 1) % statusOrder.length];

        const res = await fetch("/api/updateTask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            taskId,
            completed: nextStatus,
            sheetName: "avSetupTasks", // âœ… AV ì‹œíŠ¸ ì§€ì •
          }),
        });
        if (!res.ok) {
          alert("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
          return;
        }
        task.completed = nextStatus;
        renderTasks();
      }

      // --- ë Œë” ---
      function renderTasks() {
        const tbody = document.getElementById("worker-tasks-table");
        tbody.innerHTML = "";

        const filtered = tasks.filter((task) => {
          const teamOk = currentFilter === "All" || task.team === currentFilter;
          let dateOk = true;
          if (currentDateFilter !== "All" && task.start) {
            const taskDate = task.start
              .split(" ")[0]
              .replace(/\./g, "-")
              .trim();
            dateOk = taskDate === currentDateFilter;
          }
          return teamOk && dateOk;
        });

        const fmt = {
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };

        filtered.forEach((task) => {
          const tr = document.createElement("tr");
          tr.className = "task-row border-b border-slate-200";

          const startTime = task.start
            ? new Date(task.start.replace(/\s/g, "T"))
            : null;
          const endTime =
            startTime && task.duration
              ? new Date(startTime.getTime() + task.duration * 60000)
              : null;

          tr.innerHTML = `
            <td class="p-3 align-middle whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-slate-200 text-slate-700">${
                task.team || ""
              }</span>
            </td>
            <td class="p-4 text-center align-middle whitespace-nowrap">
              <button data-task-id="${
                task.id
              }" class="status-chip px-2 py-1 rounded-full text-white text-xs font-semibold ${
            statusColorMap[task.completed] || "bg-gray-300"
          }">
                ${task.completed}
              </button>
            </td>
            <td class="p-3 font-semibold task-name align-middle whitespace-nowrap">
              ${task.task || ""}
            </td>
            <td class="p-3 text-center align-middle whitespace-nowrap">
              ${
                task.memo && task.memo.trim() !== ""
                  ? `<button onclick="openMemoPopup('av', ${task.id})" title="ë©”ëª¨ ìˆìŒ">ğŸ“Œ</button>`
                  : `<button onclick="openMemoPopup('av', ${task.id})" title="ë©”ëª¨ ì—†ìŒ" class="opacity-10">ğŸ“Œ</button>`
              }
            </td>
            <td class="p-3 align-middle whitespace-nowrap">${
              task.person || ""
            }</td>
            <td class="p-3 align-middle text-sm whitespace-nowrap">
              ${
                startTime && !isNaN(startTime)
                  ? startTime.toLocaleString("ko-KR", fmt)
                  : "ë¯¸ì •"
              }
            </td>
            <td class="p-3 align-middle text-sm whitespace-nowrap">
              ${
                endTime && !isNaN(endTime)
                  ? endTime.toLocaleString("ko-KR", fmt)
                  : "ë¯¸ì •"
              }
            </td>
            <td class="p-3 text-center align-middle whitespace-nowrap">
              ${
                task.link
                  ? `<a href="${task.link}" target="_blank" class="inline-block text-blue-600 underline font-semibold hover:text-blue-800">ë§í¬</a>`
                  : ""
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // --- ë¡œë”©/ê°±ì‹  ---
      async function refreshData() {
        const overlay = document.getElementById("loading-overlay");
        overlay.style.display = "flex";
        overlay.style.opacity = "1";
        try {
          await fetchData();
          renderTasks();
        } finally {
          overlay.style.opacity = "0";
          setTimeout(() => (overlay.style.display = "none"), 300);
        }
      }

      // --- ë©”ëª¨ íŒì—… ë¡œì§ (fac ë™ì¼) ---
      let currentMemoTaskId = null;

      function openMemoPopup(tab, taskId) {
        currentMemoTaskId = taskId;
        const task = tasks.find((t) => t.id === taskId);
        document.getElementById("memo-textarea").value = task?.memo || "";
        document.getElementById("memo-popup").classList.remove("hidden");
      }
      function closeMemoPopup() {
        document.getElementById("memo-popup").classList.add("hidden");
        currentMemoTaskId = null;
      }
      async function saveMemo() {
        const memo = document.getElementById("memo-textarea").value.trim();
        if (!currentMemoTaskId) return;
        const res = await fetch("/api/updateMemo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ taskId: currentMemoTaskId, memo, tab: "av" }), // âœ… AV
        });
        if (!res.ok) {
          alert("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨");
          return;
        }
        const t = tasks.find((x) => x.id === currentMemoTaskId);
        if (t) t.memo = memo;
        closeMemoPopup();
        renderTasks();
      }

      // --- ì´ˆê¸°í™” ---
      window.onload = async () => {
        await refreshData();

        // íŒ€ í•„í„°
        document
          .getElementById("team-filter-controls")
          .addEventListener("click", (e) => {
            const btn = e.target.closest(".filter-btn");
            if (!btn) return;
            currentFilter = btn.dataset.team;
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            renderTasks();
          });

        // ìƒíƒœ ë³€ê²½
        document
          .getElementById("worker-tasks-table")
          .addEventListener("click", (e) => {
            const btn = e.target.closest(".status-chip");
            if (!btn) return;
            const taskId = parseInt(btn.dataset.taskId);
            updateTaskStatus(taskId);
          });

        // ë‚ ì§œ í•„í„°
        document
          .getElementById("date-filter")
          .addEventListener("change", (e) => {
            currentDateFilter = e.target.value;
            renderTasks();
          });

        // ìƒˆë¡œê³ ì¹¨
        document
          .getElementById("refresh-button")
          .addEventListener("click", refreshData);
      };
    </script>
  </body>
</html>
